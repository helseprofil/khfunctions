#' @title load_and_format_filegroups
#' @description
#' Loads filegroups as specified in parameters$filer
#' Adds FGPs and FileDesign to parameter list after loading files
#' Formatted files are stored in the global environment, in the BUFFER list. 
#' @param parameters list of parameters generated by [get_cubeparameters()]
#' @return updated parameter list after loading and formatting files
load_and_format_filegroups <- function(parameters){
  
  TABfilter <- set_tabfilter(parameters$KUBEdscr)
  FGPs <- list()
  FilDesL <- list()
  for (fil in unique(parameters$filer)) {
    tf <- ifelse(fil == parameters$filer$TELLER, TABfilter, "")
    FILinfo <- KlargjorFil(filename = fil, tabfilter = tf, versjonert = versjonert, batchdate = batchdate, filefilter = parameters$FILFILTRE, globs = globs)
    FGPs[[fil]] <- FILinfo$FGP
    FilDesL[[fil]] <- FILinfo$FILd
    invisible(gc())
  }
  parameters[["FGPs"]] <- FGPs
  parameters[["FilDesL"]] <- FilDesL
  
  return(parameters)
}

#' @title set_tabfilter
#'
#' @param KUBEdscr 
#'
#' @return
#' @export
#'
#' @examples
set_tabfilter <- function(KUBEdscr){
  TabConds <- character()
  for (tab in names(KUBEdscr)[grepl("^TAB\\d+$", names(KUBEdscr))]) {
    istab <- !is.na(KUBEdscr[[tab]]) && KUBEdscr[[tab]] != ""
    if (istab) {
      tab0 <- paste0(tab, "_0")
      istab0 <- !is.null(KUBEdscr[[tab0]]) && !is.na(KUBEdscr[[tab0]]) && KUBEdscr[[tab0]] != ""
      tablist <- KUBEdscr[[tab]]
      if (istab0) tablist <- KUBEdscr[[tab0]]
      isminus <- grepl("^-\\[", tablist)
      tablist <- gsub("^-\\[(.*)\\]$", "\\1", tablist)
      tablist <- paste0("\"", gsub(",", "\",\"", tablist), "\"")
      tabcond <- paste0("(", tab, " %in% c(", tablist, "))")
      if (isminus) tabcond <- paste0("!", tabcond)
      TabConds <- c(TabConds, tabcond)
    }
  } 
  tabfilter <- paste0(TabConds, collapse = " & ")
  return(tabfilter)
}


#' Klargjorfil
#'
#' @param FilVers 
#' @param tabfilter 
#' @param KUBEid 
#' @param versjonert 
#' @param batchdate 
#' @param GeoHarmDefault 
#' @param globs 
# KlargjorFil(FilVers = fil, TabFSub = TabFSub, KUBEid = KUBEid, versjonert = versjonert, batchdate = batchdate, globs = globs)
KlargjorFil <- function(filename, tabfilter  = "", versjonert = FALSE, batchdate = SettKHBatchDate(), filefilter = NULL, globs = SettGlobs()) {
  
  if (!exists("BUFFER", envir = .GlobalEnv)) .GlobalEnv$BUFFER <- list()
  if(!is.null(filefilter)) filter <- filefilter[FILVERSJON == filename]
  isfilter <- ifelse(!is.null(filefilter), nrow(filter) > 0, FALSE)
  isbuffer <- filename %in% names(BUFFER)
  istabfilter <- tabfilter != ""
  
  if(isfilter) FGP <- FinnFilgruppeParametre(filter$ORGFIL, batchdate = batchdate, globs = globs)
  if(!isfilter) FGP <- FinnFilgruppeParametre(filename, batchdate = batchdate, globs = globs)
  
  if(isbuffer){
    cat("Henter", filename, "fra BUFFER")
    FIL <- data.table::copy(.GlobalEnv$BUFFER[[filename]])
  } else if(!isfilter){
    FIL <- FinnFil(filename, versjonert = versjonert, globs = globs)$FT
    if(istabfilter) FIL <- do_tabfilter(file = FIL, tabfilter = tabfilter)
    FIL <- GeoHarm(FIL, vals = FGP$vals, rektiser = FALSE, batchdate = batchdate, globs = globs)
    .GlobalEnv$BUFFER[[filename]] <- FIL
  } else if(isfilter){
    FIL <- FinnFil(filter$ORGFIL, versjonert = versjonert, globs = globs)$FT
    
    if(istabfilter) FIL <- do_tabfilter(file = FIL, tabfilter = tabfilter)
    
    iskollapsdel <- grepl("\\S", filter$KOLLAPSdeler)
    if(iskollapsdel) FIL <- do_filfiltre_kollapsdeler(file = FIL, parts = filter$KOLLAPSdeler, globs = globs)
    
    isnyekolkolprerad <- grepl("\\S", filter$NYEKOL_KOL_preRAD)
    # TODO: optimalisere leggtilnyeverdikolonner
    if(isnyekolkolprerad) FIL <- LeggTilNyeVerdiKolonner(FIL, filter$NYEKOL_KOL_preRAD, slettInf = TRUE)
    
    Filter <- SettFilterDesign(filter, bruk0 = FALSE, FGP = FGP, globs = globs)
    if (length(Filter) > 0) FIL <- OmkodFil(FIL, FinnRedesign(FinnDesign(FIL, globs = globs), list(Parts = Filter), globs = globs), globs = globs)
    
    isgeoharm <- filter$GEOHARM == 1
    if(isgeoharm){
      rectangularize <- ifelse(filter$REKTISER == 1, TRUE, FALSE)
      FIL <- do_harmonize_geo(file = FIL, vals = FGP$vals, rectangularize = rectangularize, globs = globs)
    }
    
    # INAKTIV, FJERNE FRA ACCESS?
    # isnyetab <- grepl("\\S", filter$NYETAB)
    # if(isnyetab) FIL <- AggregerRader(FIL, filter$NYETAB, FGP = FGP)
    
    isnyekolrad <- grepl("\\S", filter$NYEKOL_RAD)
    if(isnyekolrad) FIL <- LeggTilSumFraRader(FIL, filter$NYEKOL_RAD, FGP = FGP, globs = globs)
    
    # INAKTIV, FJERNE FRA ACCESS?
    # isnyekolkol <- grepl("\\S", filter$NYEKOL_KOL)
    # if(isnyekolkol) FIL <- LeggTilNyeVerdiKolonner(FIL, filter$NYEKOL_KOL, slettInf = TRUE)
    
    isnykolsmerge <- grepl("\\S", filter$NYKOLSmerge)
    if(isnykolsmerge){
      # FIL <- do_filfiltre_nykolsmerge()
      cat("\nFILFILTRE:NYKOLSmerge\n")
      NY <- eval(parse(text = filter$NYKOLSmerge))
      tabK <- intersect(get_dimension_columns(names(NY)), get_dimension_columns(names(FIL)))
      data.table::setkeyv(NY, tabK)
      data.table::setkeyv(FIL, tabK)
      FIL <- NY[FIL]
    }
    
    isrsynt1 <- grepl("\\S", filter$FF_RSYNT1)
    if(isrsynt1){
      # FIKS DENNE, LEGG TIL STOP() slik at den krasjer ved feil!
      filter$FF_RSYNT1 <- gsub("\\\r", "\\\n", filter$FF_RSYNT1)
      rsynt1err <- try(eval(parse(text = filter$FF_RSYNT1)), silent = TRUE)
      if ("try-error" %in% class(rsynt1err)) {
        print(rsynt1err)
      }
    }
    .GlobalEnv$BUFFER[[filename]] <- FIL
  }
  
  FILd <- FinnDesign(FIL, FGP = FGP, globs = globs)
  return(list(FIL = FIL, FGP = FGP, FILd = FILd))
} 

do_tabfilter <- function(file, tabfilter){
  cat("Filtrer med tab-filter, før er dim", dim(file))
  file <- file[eval(rlang::parse_expr(tabfilter))]
  cat(" og etter", dim(file), "\n")
  return(file)
}

do_harmonize_geo <- function(file, vals = list(), rectangularize = TRUE, globs = SettGlobs()) {
  GEOstdAAR = getOption("khfunctions.year")
  geoomk <- globs$KnrHarm
  if(any(collapse::funique(file$GEO) %in% geoomk$GEO)){
    file <- collapse::join(file, geoomk, on = "GEO", how = "left", overid = 0, verbose = 0)
    file[!is.na(GEO_omk), let(GEO = GEO_omk)][, let(GEO_omk = NULL, HARMstd = NULL)]
  }
  if("FYLKE" %in% names(file)) collapse::settransform(file, FYLKE = NULL)
  
  # HER BUGGER DET, "object 'g' not found"
  file <- do_aggregate_file(file = file, valsumbardef = vals, globs = globs)
  # Rektangulariser
  if (rectangularize) {
    rectangularized <- data.table::data.table()
    design <- FinnDesign(file, globs = globs)
    
    for (Gn in design$Part[["Gn"]][["GEOniv"]]) {
      validgeo <- data.table::data.table(GEO = globs$GeoKoder[GEOniv == Gn & FRA <= getOption("khfunctions.year") & TIL > getOption("khfunctions.year")]$GEO)
      designgeo <- design$Design[HAR == 1 & GEOniv == Gn, mget(intersect(names(file), names(design$Design)))]
      rectangularized <- data.table::rbindlist(list(expand.grid.dt(designgeo, validgeo), 
                                                    rectangularized))
    }
    file <- collapse::join(rectangularized, file, how = "l", overid = 0, verbose = 0)
    file <- set_implicit_null_after_merge(file, vals = vals)
  }
  
  file[, FYLKE := ifelse(GEOniv %in% c("H", "L"), "00", substr(GEO, 1, 2))]
  return(file)
}

do_filfiltre_kollapsdeler <- function(file, parts, globs){
  tabcols <- get_dimension_columns(names(file))
  parts <- unlist(strsplit(parts, ","))
  columns <- as.character(globs$DefDesign$DelKolsF[parts])
  file[, (columns) := globs$TotalKoder[parts]]
  cat(paste0("Kollapser kolonnene: ", paste0(columns, collapse = ", "), ". Før er dim "), dim(file))
  file <- file[, collapse::fsum(collapse::gby(.SD, tabcols))]
  cat(" og etter", dim(file), "\n")
  return(file)
}  

#' GeoHarm (kb)
#' 
#' Helper function in KlargjorFil and LagTNtabell
#'
#' @param FIL 
#' @param vals 
#' @param rektiser 
#' @param FDesign 
#' @param batchdate 
#' @param globs 
#' @param GEOstdAAR 
GeoHarm <- function(FIL, vals = list(), rektiser = TRUE, batchdate = SettKHBatchDate(), globs = SettGlobs(), GEOstdAAR = getOption("khfunctions.year")) {
  is_kh_debug()
  
  if (identical(class(FIL), "data.frame")) {
    FIL <- data.table::setDT(FIL)
  }
  keyorg <- data.table::key(FIL)
  geoomk <- globs$KnrHarm
  
  if(any(FIL$GEO %in% geoomk$GEO)){
    FIL <- collapse::join(FIL, geoomk, on = "GEO", how = "left", verbose = 0)
    FIL[!is.na(GEO_omk), let(GEO = GEO_omk)][, let(GEO_omk = NULL, HARMstd = NULL)]
  }
  FIL[, let(FYLKE = NULL)]
  
  FIL <- KHaggreger(FIL, vals = vals, globs = globs)
  # Rektangulariser
  if (rektiser == TRUE) {
    REKT <- data.table::data.table()
    FDesign <- FinnDesign(FIL, globs = globs)
    
    FDes <- FDesign$Design
    
    # SAMME LOGIKK SOM I set_rectangularized_cube_design, bør ekstraheres ut.
    for (Gn in FDesign$Part[["Gn"]][["GEOniv"]]) {
      GEOK <- subset(globs$GeoKoder, FRA <= GEOstdAAR & TIL > GEOstdAAR & GEOniv == Gn)$GEO
      FDesG <- FDes[HAR == 1 & GEOniv == Gn, intersect(names(FIL), names(FDes)), with = FALSE]
      REKT <- rbind(data.table::data.table(expand.grid.df(data.frame(FDesG), data.frame(GEO = GEOK))), REKT)
    }
    data.table::setkeyv(REKT, names(REKT))
    data.table::setkeyv(FIL, names(REKT))
    FIL <- FIL[REKT]
    FIL <- set_implicit_null_after_merge(FIL, vals = vals)
  }
  
  FIL[, FYLKE := ifelse(GEOniv %in% c("H", "L"), "00", substr(GEO, 1, 2))]
  return(FIL)
}

do_filfiltre_kollapsdeler <- function(file, parts, globs){
  tabcols <- get_dimension_columns(names(file))
  parts <- unlist(strsplit(parts, ","))
  columns <- as.character(globs$DefDesign$DelKolsF[parts])
  file[, (columns) := globs$TotalKoder[parts]]
  cat(paste0("Kollapser kolonnene: ", paste0(columns, collapse = ", "), ". Før er dim "), dim(file))
  file <- file[, collapse::fsum(collapse::gby(.SD, tabcols))]
  cat(" og etter", dim(file), "\n")
  return(file)
}  


do_filfiltre_nykolsmerge <- function(file){
  # if (!(is.na(filter$NYKOLSmerge) | filter$NYKOLSmerge == "")) {
  #   cat("\nFILFILTRE:NYKOLSmerge\n")
  #   NY <- eval(parse(text = filter$NYKOLSmerge))
  #   tabK <- intersect(get_dimension_columns(names(NY)), get_dimension_columns(names(FIL)))
  #   data.table::setkeyv(NY, tabK)
  #   data.table::setkeyv(FIL, tabK)
  #   FIL <- NY[FIL]
  # }
  
}